import synch;
import list;

const BOUND = 2;
const NPROC = 3;

def bl_new(bound):
    result = dict{ .lock: Lock(), .count: 0, .bound: bound };
;

def bl_acquire(bl):
    let blocked = True:
        while blocked:
            lock(?bl->lock);
            if bl->count < (bl->bound - 0):
                bl->count += 1;
                blocked = False;
            ;
            unlock(?bl->lock);
        ;
    ;
;

def bl_release(bl):
    lock(?bl->lock);
    bl->count -= 1;
    unlock(?bl->lock);
;

boundlock = bl_new(BOUND);
acquired = [0,] * NPROC;

if False:
    def tester(self, bl):
        bl_acquire(bl);
        acquired[self] = 1;
        assert sum(acquired) <= BOUND;
        acquired[self] = 0;
        bl_release(bl);
    ;

    for i in {0..NPROC-1}:
        spawn tester(i, ?boundlock);
    ;
;

if True:
    def waiter(self, bl):
        bl_acquire(bl);
        acquired[self] = 1;
        await sum(acquired) >= BOUND;
        bl_release(bl);
    ;

    for i in {0..NPROC-1}:
        spawn waiter(i, ?boundlock);
    ;
;
