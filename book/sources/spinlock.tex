\>{\tiny 1}\'\>\texttt{\textbf{const}}~N~=~3\\

\>{\tiny 2}\'\>\\

\>{\tiny 3}\'\>\textit{shared}~=~\texttt{\textbf{False}}\\

\>{\tiny 4}\'\>\textit{private}~=~[~\texttt{\textbf{True}},~]~*~N\\

\>{\tiny 5}\'\>\\

\>{\tiny 6}\'\>\texttt{\textbf{invariant}}~\texttt{\textbf{len}}([~\textit{x}~\texttt{\textbf{for}}~\textit{x}~\texttt{\textbf{in}}~[\textit{shared},]~+~\textit{private}~\texttt{\textbf{where}}~\texttt{\textbf{not}}~\textit{x}~])~$<=$~1\\

\>{\tiny 7}\'\>\\

\>{\tiny 8}\'\>\texttt{\textbf{def}}~tas(\textit{s},~\textit{p}):\\

\>{\tiny 9}\'\>~~~~\texttt{\textbf{atomic}}:\\

\>{\tiny 10}\'\>~~~~~~~~!\textit{p}~=~!\textit{s}\\

\>{\tiny 11}\'\>~~~~~~~~!\textit{s}~=~\texttt{\textbf{True}}\\

\>{\tiny 12}\'\>\\

\>{\tiny 13}\'\>\texttt{\textbf{def}}~thread(\textit{self}):\\

\>{\tiny 14}\'\>~~~~\texttt{\textbf{while}}~\texttt{\textbf{choose}}(\{~\texttt{\textbf{False}},~\texttt{\textbf{True}}~\}):\\

\>{\tiny 15}\'\>~~~~~~~~\emph{\# Enter critical section}\\

\>{\tiny 16}\'\>~~~~~~~~\texttt{\textbf{while}}~\textit{private}[\textit{self}]:\\

\>{\tiny 17}\'\>~~~~~~~~~~~~tas(?\textit{shared},~?\textit{private}[\textit{self}])\\

\>{\tiny 18}\'\>\\

\>{\tiny 19}\'\>~~~~~~~~\emph{\# Critical section}\\

\>{\tiny 20}\'\>~~~~~~~~@cs:~\texttt{\textbf{assert}}~(\texttt{\textbf{not}}~\textit{private}[\textit{self}])~\texttt{\textbf{and}}~(\texttt{\textbf{atLabel}}(cs)~==~\{~(thread,~\textit{self}):~1~\})\\

\>{\tiny 21}\'\>\\

\>{\tiny 22}\'\>~~~~~~~~\emph{\# Leave critical section}\\

\>{\tiny 23}\'\>~~~~~~~~\textit{private}[\textit{self}]~=~\texttt{\textbf{True}}\\

\>{\tiny 24}\'\>~~~~~~~~\textit{shared}~=~\texttt{\textbf{False}}\\

\>{\tiny 25}\'\>\\

\>{\tiny 26}\'\>\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{0..N--1\}:\\

\>{\tiny 27}\'\>~~~~\texttt{\textbf{spawn}}~thread(\textit{i})