\>{\tiny 1}\'\>\texttt{\textbf{import}}~synch;\\

\>{\tiny 2}\'\>\\

\>{\tiny 3}\'\>\texttt{\textbf{const}}~NROUNDS~=~3;\\

\>{\tiny 4}\'\>\texttt{\textbf{const}}~NPROC~=~3;\\

\>{\tiny 5}\'\>\\

\>{\tiny 6}\'\>\texttt{\textbf{def}}~barrier\_enter(\textit{self}):\\

\>{\tiny 7}\'\>~~~~\textit{lock}(?\textit{mutex});\\

\>{\tiny 8}\'\>~~~~\textit{nstarting}~+=~1;\\

\>{\tiny 9}\'\>~~~~\texttt{\textbf{if}}~\textit{nstarting}~$<$~NPROC:\\

\>{\tiny 10}\'\>~~~~~~~~\texttt{\textbf{while}}~\textit{nstarting}~$<$~NPROC:\\

\>{\tiny 11}\'\>~~~~~~~~~~~~wait(?\textit{start});\\

\>{\tiny 12}\'\>~~~~~~~~;\\

\>{\tiny 13}\'\>~~~~\texttt{\textbf{else}}:\\

\>{\tiny 14}\'\>~~~~~~~~\textit{nfinishing}~=~0;\\

\>{\tiny 15}\'\>~~~~~~~~notifyAll(?\textit{start});\\

\>{\tiny 16}\'\>~~~~;\\

\>{\tiny 17}\'\>~~~~\textit{unlock}(?\textit{mutex});\\

\>{\tiny 18}\'\>;\\

\>{\tiny 19}\'\>\texttt{\textbf{def}}~barrier\_exit(\textit{self}):\\

\>{\tiny 20}\'\>~~~~\textit{lock}(?\textit{mutex});\\

\>{\tiny 21}\'\>~~~~\textit{nfinishing}~+=~1;\\

\>{\tiny 22}\'\>~~~~\texttt{\textbf{if}}~\textit{nfinishing}~$<$~NPROC:\\

\>{\tiny 23}\'\>~~~~~~~~\texttt{\textbf{while}}~\textit{nfinishing}~$<$~NPROC:\\

\>{\tiny 24}\'\>~~~~~~~~~~~~wait(?\textit{finish});\\

\>{\tiny 25}\'\>~~~~~~~~;\\

\>{\tiny 26}\'\>~~~~\texttt{\textbf{else}}:\\

\>{\tiny 27}\'\>~~~~~~~~\textit{nstarting}~=~0;\\

\>{\tiny 28}\'\>~~~~~~~~notifyAll(?\textit{finish});\\

\>{\tiny 29}\'\>~~~~;\\

\>{\tiny 30}\'\>~~~~\textit{unlock}(?\textit{mutex});\\

\>{\tiny 31}\'\>;\\

\>{\tiny 32}\'\>\textit{mutex}~=~\textit{Lock}();\\

\>{\tiny 33}\'\>\textit{start}~=~\textit{Condition}(?\textit{mutex});\\

\>{\tiny 34}\'\>\textit{finish}~=~\textit{Condition}(?\textit{mutex});\\

\>{\tiny 35}\'\>\textit{nstarting}~=~0;\\

\>{\tiny 36}\'\>\textit{nfinishing}~=~0;\\

\>{\tiny 37}\'\>\\

\>{\tiny 38}\'\>\emph{\# check that all non$-$None values in round are the same}\\

\>{\tiny 39}\'\>\texttt{\textbf{def}}~check():\\

\>{\tiny 40}\'\>~~~~\textit{result}~=~\texttt{\textbf{True}};\\

\>{\tiny 41}\'\>~~~~\texttt{\textbf{let}}~\textit{x}~=~\texttt{\textbf{None}}:\\

\>{\tiny 42}\'\>~~~~~~~~\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{0..NPROC--1\}:\\

\>{\tiny 43}\'\>~~~~~~~~~~~~\texttt{\textbf{if}}~\textit{result}~\texttt{\textbf{and}}~(\textit{round}[\textit{i}]~!=~\texttt{\textbf{None}}):\\

\>{\tiny 44}\'\>~~~~~~~~~~~~~~~~\texttt{\textbf{if}}~\textit{x}~!=~\texttt{\textbf{None}}:\\

\>{\tiny 45}\'\>~~~~~~~~~~~~~~~~~~~~\textit{result}~=~\textit{round}[\textit{i}]~==~\textit{x};\\

\>{\tiny 46}\'\>~~~~~~~~~~~~~~~~;\\

\>{\tiny 47}\'\>~~~~~~~~~~~~~~~~\textit{x}~=~\textit{round}[\textit{i}];\\

\>{\tiny 48}\'\>~~~~~~~~~~~~;\\

\>{\tiny 49}\'\>~~~~~~~~;\\

\>{\tiny 50}\'\>~~~~;\\

\>{\tiny 51}\'\>;\\

\>{\tiny 52}\'\>\\

\>{\tiny 53}\'\>\texttt{\textbf{def}}~process(\textit{self}):\\

\>{\tiny 54}\'\>~~~~\texttt{\textbf{for}}~\textit{r}~\texttt{\textbf{in}}~\{0..NROUNDS--1\}:\\

\>{\tiny 55}\'\>~~~~~~~~barrier\_enter(\textit{self});\\

\>{\tiny 56}\'\>~~~~~~~~\textit{round}[\textit{self}]~=~\textit{r};\\

\>{\tiny 57}\'\>~~~~~~~~\texttt{\textbf{assert}}~check();\\

\>{\tiny 58}\'\>~~~~~~~~\textit{round}[\textit{self}]~=~\texttt{\textbf{None}};\\

\>{\tiny 59}\'\>~~~~~~~~barrier\_exit(\textit{self});\\

\>{\tiny 60}\'\>~~~~;\\

\>{\tiny 61}\'\>~~~~\textit{done}[\textit{self}]~=~\texttt{\textbf{True}};\\

\>{\tiny 62}\'\>;\\

\>{\tiny 63}\'\>\texttt{\textbf{def}}~main():\\

\>{\tiny 64}\'\>~~~~\texttt{\textbf{await}}~\texttt{\textbf{all}}(\textit{done});\\

\>{\tiny 65}\'\>;\\

\>{\tiny 66}\'\>\\

\>{\tiny 67}\'\>\textit{round}~=~[\texttt{\textbf{None}},]~*~NPROC;\\

\>{\tiny 68}\'\>\textit{done}~=~[\texttt{\textbf{False}},]~*~NPROC;\\

\>{\tiny 69}\'\>\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{0..NPROC--1\}:\\

\>{\tiny 70}\'\>~~~~\texttt{\textbf{spawn}}~process(\textit{i});\\

\>{\tiny 71}\'\>;\\

\>{\tiny 72}\'\>\texttt{\textbf{spawn}}~main();