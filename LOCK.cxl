def tas(self):
    atomic:
        var oldval = !(self);
        !(self) := True;
        self := oldval;
    .
.
def lock(lk):
    while tas(lk): pass.
.
def unlock(lk):
    !(lk) := False;
.
def p():
    while True:
        call lock&(mylock);
        @cs: pass   # critical section
        call unlock&(mylock);
    .
.
mylock := False;
spawn p(), 0;
spawn p(), 1;
