def Barrier(required) returns barrier:
    barrier = { .required: required, .left: required, .cycle: 0 }

def bwait(b):
    var cycle = None
    atomically:
        cycle = b->cycle
        b->left -= 1
        if b->left == 0:
            b->cycle = (b->cycle + 1) % 2
            b->left = b->required
    atomically await b->cycle != cycle
