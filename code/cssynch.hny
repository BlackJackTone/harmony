import synch

const NTHREADS = 2

in_cs = 0
invariant in_cs in { 0, 1 }

lock = synch.Lock()

def thread():
    while choose({ False, True }):
        synch.acquire(?lock)

        atomically in_cs += 1
        # Critical section
        atomically in_cs -= 1

        synch.release(?lock)

for i in {1..NTHREADS}:
    spawn thread()
