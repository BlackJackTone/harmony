routine tas(self):
    atomic:
        var oldval = !(self);
        !(self) := True;
        self := oldval;
    end atomic
end routine

routine lock(lk):
    while tas(lk): end while
end routine

routine unlock(lk):
    !(lk) := False;
end routine

routine p(arg):
    while True:
        call lock&(mylock);
        @cs: skip // critical section
        call unlock&(mylock);
    end while
end routine

mylock := False;

spawn p(0), 0;
spawn p(0), 0;
spawn p(0), 0;
spawn p(0), 0;
