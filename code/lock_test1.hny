from lock import Lock, acquire, release

const NTHREADS = 5

thelock = Lock()
count = 0

def thread():
    while choose { False, True }:
        acquire(?thelock)
        atomically count += 1
        assert count == 1
        atomically count -= 1
        release(?thelock)

for i in {1..NTHREADS}:
    spawn thread()
