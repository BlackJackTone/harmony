\>{\tiny 1}\'\>\texttt{\textbf{from}}~synch~\texttt{\textbf{import}}~BinSema,~acquire,~release\\

\>{\tiny 2}\'\>\\

\>{\tiny 3}\'\>\texttt{\textbf{def}}~RWlock():\\

\>{\tiny 4}\'\>~~~~\textit{result}~=~\{\\

\>{\tiny 5}\'\>~~~~~~~~~~~~.nreaders:~0,~.nwriters:~0,~.mutex:~BinSema(\texttt{\textbf{False}}),\\

\>{\tiny 6}\'\>~~~~~~~~~~~~.r\_gate:~\{~.sema:~BinSema(\texttt{\textbf{True}}),~.count:~0~\},\\

\>{\tiny 7}\'\>~~~~~~~~~~~~.w\_gate:~\{~.sema:~BinSema(\texttt{\textbf{True}}),~.count:~0~\}\\

\>{\tiny 8}\'\>~~~~~~~~\}\\

\>{\tiny 9}\'\>\\

\>{\tiny 10}\'\>\texttt{\textbf{def}}~read\_acquire(\textit{rw}):\\

\>{\tiny 11}\'\>~~~~acquire(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 12}\'\>~~~~\texttt{\textbf{if}}~(\textit{rw}$\rightarrow$nwriters~$>$~0)~\texttt{\textbf{or}}~(\textit{rw}$\rightarrow$w\_gate.count~$>$~0):\\

\>{\tiny 13}\'\>~~~~~~~~\textit{rw}$\rightarrow$r\_gate.count~+=~1;~release(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 14}\'\>~~~~~~~~acquire(?\textit{rw}$\rightarrow$r\_gate.sema);~\textit{rw}$\rightarrow$r\_gate.count~--=~1\\

\>{\tiny 15}\'\>~~~~\textit{rw}$\rightarrow$nreaders~+=~1\\

\>{\tiny 16}\'\>~~~~\texttt{\textbf{if}}~\textit{rw}$\rightarrow$r\_gate.count~$>$~0:\\

\>{\tiny 17}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$r\_gate.sema)\\

\>{\tiny 18}\'\>~~~~\texttt{\textbf{else}}:\\

\>{\tiny 19}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 20}\'\>\\

\>{\tiny 21}\'\>\texttt{\textbf{def}}~read\_release(\textit{rw}):\\

\>{\tiny 22}\'\>~~~~acquire(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 23}\'\>~~~~\textit{rw}$\rightarrow$nreaders~--=~1\\

\>{\tiny 24}\'\>~~~~\texttt{\textbf{if}}~(\textit{rw}$\rightarrow$w\_gate.count~$>$~0)~\texttt{\textbf{and}}~(\textit{rw}$\rightarrow$nreaders~==~0):\\

\>{\tiny 25}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$w\_gate.sema)\\

\>{\tiny 26}\'\>~~~~\texttt{\textbf{else}}:\\

\>{\tiny 27}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 28}\'\>~~~~\\

\>{\tiny 29}\'\>\texttt{\textbf{def}}~write\_acquire(\textit{rw}):\\

\>{\tiny 30}\'\>~~~~acquire(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 31}\'\>~~~~\texttt{\textbf{if}}~(\textit{rw}$\rightarrow$nreaders~+~\textit{rw}$\rightarrow$nwriters)~$>$~0:\\

\>{\tiny 32}\'\>~~~~~~~~\textit{rw}$\rightarrow$w\_gate.count~+=~1;~release(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 33}\'\>~~~~~~~~acquire(?\textit{rw}$\rightarrow$w\_gate.sema);~\textit{rw}$\rightarrow$w\_gate.count~--=~1\\

\>{\tiny 34}\'\>~~~~\textit{rw}$\rightarrow$nwriters~+=~1\\

\>{\tiny 35}\'\>~~~~release(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 36}\'\>\\

\>{\tiny 37}\'\>\texttt{\textbf{def}}~write\_release(\textit{rw}):\\

\>{\tiny 38}\'\>~~~~acquire(?\textit{rw}$\rightarrow$mutex)\\

\>{\tiny 39}\'\>~~~~\textit{rw}$\rightarrow$nwriters~--=~1\\

\>{\tiny 40}\'\>~~~~\texttt{\textbf{if}}~\textit{rw}$\rightarrow$r\_gate.count~$>$~0:\\

\>{\tiny 41}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$r\_gate.sema)\\

\>{\tiny 42}\'\>~~~~\texttt{\textbf{elif}}~\textit{rw}$\rightarrow$w\_gate.count~$>$~0:\\

\>{\tiny 43}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$w\_gate.sema)\\

\>{\tiny 44}\'\>~~~~\texttt{\textbf{else}}:\\

\>{\tiny 45}\'\>~~~~~~~~release(?\textit{rw}$\rightarrow$mutex)