\>{\tiny 1}\'\>\texttt{\textbf{from}}~synch~\texttt{\textbf{import}}~Lock,~acquire,~release\\

\>{\tiny 2}\'\>\\

\>{\tiny 3}\'\>\texttt{\textbf{const}}~N\_ACCOUNTS~=~2\\

\>{\tiny 4}\'\>\texttt{\textbf{const}}~N\_CUSTOMERS~=~2\\

\>{\tiny 5}\'\>\texttt{\textbf{const}}~N\_ATMS~=~2\\

\>{\tiny 6}\'\>\texttt{\textbf{const}}~MAX\_BALANCE~=~1\\

\>{\tiny 7}\'\>\\

\>{\tiny 8}\'\>\textit{accounts}~=~[~\{~.lock:~Lock(),~.balance:~\texttt{\textbf{choose}}(\{0..MAX\_BALANCE\})\}\\

\>{\tiny 9}\'\>~~~~~~~~~~~~~~~~~~~~~~~~~~~~\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{1..N\_ACCOUNTS\}~]\\

\>{\tiny 10}\'\>\\

\>{\tiny 11}\'\>\texttt{\textbf{invariant}}~\texttt{\textbf{min}}(\textit{accounts}[\textit{acct}].balance~\texttt{\textbf{for}}~\textit{acct}~\texttt{\textbf{in}}~\{0..N\_ACCOUNTS--1\})~$>=$~0\\

\>{\tiny 12}\'\>\\

\>{\tiny 13}\'\>\texttt{\textbf{def}}~atm\_check\_balance(\textit{acct}):~~~~\emph{\# return the balance on acct}\\

\>{\tiny 14}\'\>~~~~acquire(?\textit{accounts}[\textit{acct}].lock)\\

\>{\tiny 15}\'\>~~~~\textit{result}~=~\textit{accounts}[\textit{acct}].balance\\

\>{\tiny 16}\'\>~~~~release(?\textit{accounts}[\textit{acct}].lock)\\

\>{\tiny 17}\'\>\\

\>{\tiny 18}\'\>\texttt{\textbf{def}}~atm\_withdraw(\textit{acct},~\textit{amount}):~\emph{\# withdraw amount from acct}\\

\>{\tiny 19}\'\>~~~~acquire(?\textit{accounts}[\textit{acct}].lock)\\

\>{\tiny 20}\'\>~~~~\textit{accounts}[\textit{acct}].balance~--=~\textit{amount}\\

\>{\tiny 21}\'\>~~~~\textit{result}~=~\texttt{\textbf{True}}~~~~~~~~~~~~~~\emph{\# return success}\\

\>{\tiny 22}\'\>~~~~release(?\textit{accounts}[\textit{acct}].lock)\\

\>{\tiny 23}\'\>\\

\>{\tiny 24}\'\>\texttt{\textbf{def}}~customer(\textit{atm},~\textit{acct},~\textit{amount}):\\

\>{\tiny 25}\'\>~~~~\texttt{\textbf{let}}~\textit{bal}~=~atm\_check\_balance(\textit{acct}):\\

\>{\tiny 26}\'\>~~~~~~~~\texttt{\textbf{if}}~\textit{amount}~$<=$~\textit{bal}:\\

\>{\tiny 27}\'\>~~~~~~~~~~~~atm\_withdraw(\textit{acct},~\textit{amount})\\

\>{\tiny 28}\'\>~~~~~~~~\\

\>{\tiny 29}\'\>\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{1..N\_ATMS\}:\\

\>{\tiny 30}\'\>~~~~\texttt{\textbf{spawn}}~customer(\textit{i},~\texttt{\textbf{choose}}(\{0..N\_ACCOUNTS--1\}),\\

\>{\tiny 31}\'\>~~~~~~~~~~~~~~~~~~~~~~\texttt{\textbf{choose}}(\{0..MAX\_BALANCE\}))