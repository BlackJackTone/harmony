lock = False

def tas(s):
    atomically:
        result = !s
        !s = True

def clear(s):
    atomically:
        assert !s
        !s = False
    
def thread():
    while choose({ False, True }):
        while tas(?lock):
            pass
        @cs: assert countLabel(cs) == 1
        clear(?lock)
    
for i in {1..10}:
    spawn thread()
