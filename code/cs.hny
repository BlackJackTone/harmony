in_cs = 0

def thread():
    while choose({ False, True }):
        atomically in_cs += 1  # enter critical section
        assert in_cs == 1
        atomically in_cs -= 1  # exit critical section
    
spawn thread()
spawn thread()
