\>{\tiny 1}\'\>\texttt{\textbf{import}}~synch;\\

\>{\tiny 2}\'\>\\

\>{\tiny 3}\'\>\texttt{\textbf{const}}~NROUNDS~=~3;\\

\>{\tiny 4}\'\>\texttt{\textbf{const}}~NPROC~=~3;\\

\>{\tiny 5}\'\>\\

\>{\tiny 6}\'\>\texttt{\textbf{def}}~barrier\_enter(\textit{self}):\\

\>{\tiny 7}\'\>~~~~\textit{lock}(?\textit{mutex});\\

\>{\tiny 8}\'\>~~~~\texttt{\textbf{while}}~\textit{bstate}~$>=$~NPROC:\\

\>{\tiny 9}\'\>~~~~~~~~wait(?\textit{start});\\

\>{\tiny 10}\'\>~~~~;\\

\>{\tiny 11}\'\>~~~~\textit{bstate}~+=~1;\\

\>{\tiny 12}\'\>~~~~\texttt{\textbf{if}}~\textit{bstate}~==~NPROC:\\

\>{\tiny 13}\'\>~~~~~~~~notifyAll(?\textit{finish});\\

\>{\tiny 14}\'\>~~~~;\\

\>{\tiny 15}\'\>~~~~\textit{unlock}(?\textit{mutex});\\

\>{\tiny 16}\'\>;\\

\>{\tiny 17}\'\>\texttt{\textbf{def}}~barrier\_exit(\textit{self}):\\

\>{\tiny 18}\'\>~~~~\textit{lock}(?\textit{mutex});\\

\>{\tiny 19}\'\>~~~~\texttt{\textbf{while}}~\textit{bstate}~$<$~NPROC:\\

\>{\tiny 20}\'\>~~~~~~~~wait(?\textit{finish});\\

\>{\tiny 21}\'\>~~~~;\\

\>{\tiny 22}\'\>~~~~\textit{bstate}~=~(\textit{bstate}~+~1)~\%~(2~*~NPROC);\\

\>{\tiny 23}\'\>~~~~\texttt{\textbf{if}}~\textit{bstate}~==~0:\\

\>{\tiny 24}\'\>~~~~~~~~notifyAll(?\textit{start});\\

\>{\tiny 25}\'\>~~~~;\\

\>{\tiny 26}\'\>~~~~\textit{unlock}(?\textit{mutex});\\

\>{\tiny 27}\'\>;\\

\>{\tiny 28}\'\>\textit{mutex}~=~\textit{Lock}();\\

\>{\tiny 29}\'\>\textit{start}~=~\textit{Condition}(?\textit{mutex});\\

\>{\tiny 30}\'\>\textit{finish}~=~\textit{Condition}(?\textit{mutex});\\

\>{\tiny 31}\'\>\textit{bstate}~=~0;\\

\>{\tiny 32}\'\>\\

\>{\tiny 33}\'\>\emph{\# check that all non$-$None values in round are the same}\\

\>{\tiny 34}\'\>\texttt{\textbf{def}}~check():\\

\>{\tiny 35}\'\>~~~~\textit{result}~=~\texttt{\textbf{True}};\\

\>{\tiny 36}\'\>~~~~\texttt{\textbf{let}}~\textit{x}~=~\texttt{\textbf{None}}:\\

\>{\tiny 37}\'\>~~~~~~~~\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{0..NPROC--1\}:\\

\>{\tiny 38}\'\>~~~~~~~~~~~~\texttt{\textbf{if}}~\textit{result}~\texttt{\textbf{and}}~(\textit{round}[\textit{i}]~!=~\texttt{\textbf{None}}):\\

\>{\tiny 39}\'\>~~~~~~~~~~~~~~~~\texttt{\textbf{if}}~\textit{x}~!=~\texttt{\textbf{None}}:\\

\>{\tiny 40}\'\>~~~~~~~~~~~~~~~~~~~~\textit{result}~=~\textit{round}[\textit{i}]~==~\textit{x};\\

\>{\tiny 41}\'\>~~~~~~~~~~~~~~~~;\\

\>{\tiny 42}\'\>~~~~~~~~~~~~~~~~\textit{x}~=~\textit{round}[\textit{i}];\\

\>{\tiny 43}\'\>~~~~~~~~~~~~;\\

\>{\tiny 44}\'\>~~~~~~~~;\\

\>{\tiny 45}\'\>~~~~;\\

\>{\tiny 46}\'\>;\\

\>{\tiny 47}\'\>\\

\>{\tiny 48}\'\>\texttt{\textbf{def}}~process(\textit{self}):\\

\>{\tiny 49}\'\>~~~~\texttt{\textbf{for}}~\textit{r}~\texttt{\textbf{in}}~\{0..NROUNDS--1\}:\\

\>{\tiny 50}\'\>~~~~~~~~barrier\_enter(\textit{self});\\

\>{\tiny 51}\'\>~~~~~~~~\textit{round}[\textit{self}]~=~\textit{r};\\

\>{\tiny 52}\'\>~~~~~~~~\texttt{\textbf{assert}}~check();\\

\>{\tiny 53}\'\>~~~~~~~~\textit{round}[\textit{self}]~=~\texttt{\textbf{None}};\\

\>{\tiny 54}\'\>~~~~~~~~barrier\_exit(\textit{self});\\

\>{\tiny 55}\'\>~~~~;\\

\>{\tiny 56}\'\>~~~~\textit{done}[\textit{self}]~=~\texttt{\textbf{True}};\\

\>{\tiny 57}\'\>;\\

\>{\tiny 58}\'\>\texttt{\textbf{def}}~main():\\

\>{\tiny 59}\'\>~~~~\texttt{\textbf{await}}~\texttt{\textbf{all}}(\textit{done});\\

\>{\tiny 60}\'\>;\\

\>{\tiny 61}\'\>\\

\>{\tiny 62}\'\>\textit{round}~=~[\texttt{\textbf{None}},]~*~NPROC;\\

\>{\tiny 63}\'\>\textit{done}~=~[\texttt{\textbf{False}},]~*~NPROC;\\

\>{\tiny 64}\'\>\texttt{\textbf{for}}~\textit{i}~\texttt{\textbf{in}}~\{0..NPROC--1\}:\\

\>{\tiny 65}\'\>~~~~\texttt{\textbf{spawn}}~process(\textit{i});\\

\>{\tiny 66}\'\>;\\

\>{\tiny 67}\'\>\texttt{\textbf{spawn}}~main();