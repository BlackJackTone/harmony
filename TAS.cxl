# Correct mutual exclusion using Test-And-Set

import synch;

def p():
    while True:
        @ncs: assert True, True;
        while tas&(mylock):
            pass;
        ;
        @cs: assert (atLabel "cs") == dict{ nametag(): 1 }, atLabel("cs");
        mylock = False;
    ;
;
mylock = Lock();
atomic:
    spawn p(), 0;
    spawn p(), 0;
    spawn p(), 1;
    spawn p(), 1;
;
