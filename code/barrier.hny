def Barrier(required) returns barrier:
    barrier = { .required: required, .left: required, .color: 0 }

def bwait(b):
    var color = None
    atomically:
        color = b->color
        b->left -= 1
        if b->left == 0:
            b->color ^= 1
            b->left = b->required
    atomically await b->color != color
