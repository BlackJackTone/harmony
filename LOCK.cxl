def tas(self):
    atomic:
        var oldval = !(self);
        !(self) := True;
        self := oldval;
    end atomic
end def

def lock(lk):
    while tas(lk): end while
end def

def unlock(lk):
    !(lk) := False;
end def

def p(arg):
    while True:
        call lock&(mylock);
        @cs: skip   # critical section
        call unlock&(mylock);
    end while
end def

mylock := False;

spawn p(0), 0;
spawn p(0), 0;
spawn p(0), 0;
spawn p(0), 0;
