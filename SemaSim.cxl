routine P(sema):
    var blocked = True;
    while blocked:
        atomic:
            if !(sema) > 0:
                !(sema) := !(sema) - 1;
                blocked := False;
            end if
        end atomic
    end while
end routine

routine V(sema):
    atomic:
        !(sema) := !(sema) + 1;
    end atomic
end routine

routine p():
    while True:
        call P&(mysema);
        @cs: // critical section
        call V&(mysema);
    end while
end routine

mysema := 1;
spawn p(), 0;
spawn p(), 1;
spawn p(), 2;
spawn p(), 3;
